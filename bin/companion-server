#!/usr/bin/env bash
# Companion Server - caddy reverse proxy with basic auth for the-companion
set -euo pipefail

COMPANION_PORT=19456
CADDY_PORT=8080
COMPANION_PID=""
CADDYFILE=""
SLEEP_DISABLED=false
FIREWALL_ACTIVE=false
SHUTTING_DOWN=false

for cmd in caddy the-companion op; do
  if ! command -v "$cmd" &>/dev/null; then
    echo "Error: $cmd is not installed" >&2
    exit 1
  fi
done

LOCAL_IP=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null || echo "unknown")
AUTH_USER=$(op read "op://Employee/claude-code-server/username")
AUTH_PASS=$(op read "op://Employee/claude-code-server/password")
HASHED_PASS=$(caddy hash-password --plaintext "$AUTH_PASS")
CADDYFILE=$(mktemp /tmp/companion-server-XXXXXX.caddyfile)

cat > "$CADDYFILE" <<EOF
:${CADDY_PORT} {
    basicauth * {
        ${AUTH_USER} ${HASHED_PASS}
    }
    reverse_proxy 127.0.0.1:${COMPANION_PORT}
}
EOF

cleanup() {
  SHUTTING_DOWN=true
  echo ""
  echo "Shutting down..."

  if [[ -n "$COMPANION_PID" ]]; then
    kill "$COMPANION_PID" 2>/dev/null || true
    wait "$COMPANION_PID" 2>/dev/null || true
  fi

  caddy stop 2>/dev/null || true

  if [[ "$FIREWALL_ACTIVE" == true ]]; then
    echo "Removing firewall rule..."
    sudo pfctl -a "companion" -F all 2>/dev/null || true
    FIREWALL_ACTIVE=false
  fi

  rm -f "$CADDYFILE"

  if [[ "$SLEEP_DISABLED" == true ]]; then
    echo "Re-enabling sleep..."
    sudo pmset -a disablesleep 0
    SLEEP_DISABLED=false
  fi
}
trap cleanup EXIT INT TERM

echo "Blocking external access to port ${COMPANION_PORT}..."
echo "block in on ! lo0 proto tcp to any port ${COMPANION_PORT}" | sudo pfctl -a "companion" -f - 2>/dev/null
sudo pfctl -e 2>/dev/null || true
FIREWALL_ACTIVE=true

echo "Disabling sleep (lid close protection)..."
sudo pmset -a disablesleep 1
SLEEP_DISABLED=true

echo "Starting Caddy on :${CADDY_PORT}..."
caddy start --config "$CADDYFILE"

URL="http://${LOCAL_IP}:${CADDY_PORT}"

echo ""
echo "Companion Server running at:"
echo "  ${URL}"
echo ""
if command -v qrcode-terminal &>/dev/null; then
  echo "${URL}" | qrcode-terminal
  echo ""
fi

while [[ "$SHUTTING_DOWN" == false ]]; do
  echo "Starting the-companion on port ${COMPANION_PORT}..."
  PORT=$COMPANION_PORT the-companion serve &
  COMPANION_PID=$!
  wait "$COMPANION_PID" || true
  COMPANION_PID=""

  if [[ "$SHUTTING_DOWN" == true ]]; then
    break
  fi

  echo "Companion exited, restarting in 3s..."
  sleep 3
done
