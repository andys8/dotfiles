#!/usr/bin/env bash
set -euo pipefail

repo_name=$(basename "$(git rev-parse --show-toplevel)")
default_branch=$(git default-branch)
current_branch=$(git branch --show-current)

branch="${1:-}"

if [[ -z "$branch" ]]; then
    branch="$current_branch"
    if [[ "$branch" == "$default_branch" ]]; then
        echo "Error: Cannot create worktree from default branch without specifying a branch name" >&2
        exit 1
    fi
    echo "No branch specified, using current branch: $branch" >&2
    echo "Switching to $default_branch first..." >&2
    git checkout "$default_branch" >&2
else
    echo "Using branch: $branch" >&2
fi

branch_safe="${branch//\//-}"
worktree_path="../$repo_name-$branch_safe"

if ! git show-ref --verify --quiet "refs/heads/$branch"; then
    echo "Branch not found locally, fetching from remote..." >&2
    git fetch >&2

    if ! git show-ref --verify --quiet "refs/heads/$branch" && \
       ! git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
        echo "Branch '$branch' does not exist. Creating new branch from $default_branch..." >&2
        git branch "$branch" "$default_branch" >&2
    fi
fi

echo "Creating worktree at: $worktree_path" >&2
git worktree add "$worktree_path" "$branch" >&2
echo "Worktree created successfully at: $worktree_path" >&2

pushd "$worktree_path" > /dev/null

echo "Installing tools" >&2
if asdf install 2>/dev/null; then
    echo "Tools installed successfully" >&2
else
    echo "Warning: asdf install failed" >&2
fi

echo "Installing dependencies..." >&2
if [[ -f "pnpm-lock.yaml" ]]; then
    if pnpm i --prefer-offline --frozen-lockfile >&2; then
        echo "Dependencies installed successfully" >&2
    else
        echo "Warning: Failed to install dependencies" >&2
    fi
elif command -v ni &> /dev/null && ni >&2; then
    echo "Dependencies installed successfully" >&2
else
    echo "Warning: Failed to install dependencies" >&2
fi

popd > /dev/null

# Print the worktree path to stdout (this is the only stdout output)
echo "$worktree_path"
