#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: gitlab-jobs <pipeline-id> [<name-filter>]"
    exit 1
fi

if ! command -v glab &>/dev/null; then
    echo "Error: glab is not installed. Please install glab to use this script."
    exit 1
fi

if ! command -v jq &>/dev/null; then
    echo "Error: jq is not installed. Please install glab to use this script."
    exit 1
fi

pipeline_id=$1
filter=${2:-}

echo "Fetching jobs for pipeline ID: $pipeline_id"

# Fetch pipeline jobs JSON once
pipeline_json=$(glab ci get -p "$pipeline_id" -F json)

# Extract job names
jq_expr_name='.jobs | map(select(.name | startswith("'$filter'"))) | map(.name) | .[]'
job_names=$(echo "$pipeline_json" | jq -r "$jq_expr_name" | sort)

# Extract job IDs
jq_expr_id='.jobs | map(select(.name | startswith("'$filter'"))) | map(.id) | .[]'
job_ids=$(echo "$pipeline_json" | jq -r "$jq_expr_id" | sort)

if [ -z "$job_ids" ]; then
    echo "No jobs found for pipeline ID: $pipeline_id"
    exit 1
fi

echo "Job Names:"
echo "$job_names"

# Create the output file path
output_file="/tmp/gitlab-jobs-${pipeline_id}-${filter}.txt"

# Initialize or clear the output file
>"$output_file"

for job_id in $job_ids; do
    echo "Fetching logs for job ID: $job_id"
    echo "===== Logs for Job ID: $job_id =====" >>"$output_file"
    glab ci trace "$job_id" >>"$output_file" 2>&1
    echo "===== End of Logs for Job ID: $job_id =====" >>"$output_file"
done

echo "Logs have been fetched and saved to ${output_file}"
