#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: gitlab-jobs <pipeline-id> [<name-filter>]"
    exit 1
fi

if ! command -v glab &>/dev/null; then
    echo "Error: glab is not installed. Please install glab to use this script."
    exit 1
fi

if ! command -v jq &>/dev/null; then
    echo "Error: jq is not installed. Please install glab to use this script."
    exit 1
fi

pipeline_id=$1
filter=${2:-}

jq_expr='.jobs | map(select(.name | contains("'$filter'"))) | map(.id) | .[]'
job_ids=$(glab ci get -p "$pipeline_id" -F json | jq -r "$jq_expr")

# Create the output file path
output_file="/tmp/gitlab-jobs-${pipeline_id}-${filter}.txt"

# Initialize or clear the output file
>"$output_file"

for job_id in $job_ids; do
    echo "Fetching logs for job ID: $job_id"
    echo "===== Logs for Job ID: $job_id =====" >>"$output_file"
    glab ci trace "$job_id" >>"$output_file" 2>&1
    echo "===== End of Logs for Job ID: $job_id =====" >>"$output_file"
done

echo "Logs have been fetched and saved to ${output_file}"
